class t{constructor(t){this._events={}}on(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)}emit(t,...e){let s=this._events[t];s&&s.forEach((t=>{setTimeout((()=>t(...e)),0)}))}}class e{window=0;cursor=0;data=new Uint8Array(2048);add(t){this.cursor==this.window&&(this.cursor=this.window=0),this.data.set(new Uint8Array(t.buffer),this.window),this.window+=t.byteLength}get(t,e){return t||(t=0),e?this.data.subarray(t+this.cursor,e+this.cursor):this.data[t+this.cursor]}getWord(t){return this.data[t+this.cursor]|this.data[t+this.cursor+1]<<8}getBit(t,e){return this.data[t+this.cursor]>>e&1}getBits(t,e){"string"==typeof t&&(e=t,t=0);let s=e.split("").map(((t,e)=>[7-e,"."!=t?parseInt(t,10):null])).filter((t=>null!==t[1])),i=0;for(let e of s)i|=this.getBit(t,e[0])<<e[1];return i}scanUntilLineFeedNul(t){let e,s=!1;for(e=this.cursor;e<t;e++)if(10==this.data[e-1]&&0==this.data[e]){s=!0,e++;break}return s?e-this.cursor:null}scanUntilNul(t){let e,s=!1;for(e=this.cursor;e<t;e++)if(0==this.data[e]){s=!0,e++;break}return s?e-this.cursor:null}checkBit(t,e,s){return(this.data[t+this.cursor]>>e&1)===s}checkBits(t,e){"string"==typeof t&&(e=t,t=0),"string"==typeof e&&(e=e.split("").map(((t,e,s)=>[s.length-e-1,parseInt(t)])).filter((t=>!isNaN(t[1]))));for(let s of e)if(!this.checkBit(t,s[0],s[1]))return!1;return!0}checkSequence(t,e){t instanceof Array&&(e=t,t=0);for(let s=0;s<e.length;s++)if(this.data[t+this.cursor+s]!=e[s])return!1;return!0}get length(){return this.window-this.cursor}}class s{static create(t){let e=t.callback,s=t.target;return new Proxy(s,{get:(t,e,s)=>"target"===e?t:Reflect.get(t,e,s),set:(t,s,i)=>(t[s]!==i&&(t[s]=i,e(t)),!0)})}}class i{buttonPressed=!1;online=!0;coverOpened=!1;paperLoaded=!0;paperLow=!1}class n{#t;#e;#s=!1;#i=!1;constructor(e){this.#t=e,this.#e=new t,"star-prnt"==this.#t._language&&(this.#i=!0)}get supported(){return this.#i}get connected(){return this.#s}set connected(t){!this.#s&&t&&this.#e.emit("connected"),this.#s=t,this.#i=!0}set barcode(t){this.#e.emit("barcode",{value:t})}addEventListener(t,e){this.#e.on(t,e)}}class r{#t;#e;#n=!1;constructor(e){this.#t=e,this.#e=new t}open(){this.#t.connected&&("esc-pos"==this.#t.language&&this.#t.send([27,112,0,25,250]),"star-prnt"!=this.#t.language&&"star-line"!=this.#t.language||this.#t.send([27,7,20,20,7]))}get supported(){return!0}get opened(){return this.#n}set opened(t){t!==this.#n&&(this.#e.emit("update",{opened:t}),t?this.#e.emit("open"):this.#e.emit("close")),this.#n=t}addEventListener(t,e){this.#e.on(t,e)}}class a{constructor(a){if(this._connected=!1,a.language=a.language||"auto",void 0===a.printer)throw new Error("You need to provide a printer driver instance");if(!(a.printer instanceof WebUSBReceiptPrinter||a.printer instanceof WebSerialReceiptPrinter))throw new Error("Printer driver not supported by this library");if(!["esc-pos","star-prnt","star-line","auto"].includes(a.language))throw new Error("Language not supported by this library");this._language=a.language,this._parsing=!1,this._polling=null,this._updates=0,this._pollForUpdates=!1,this._pollForBarcodes=!1,this._internal={emitter:new t,decoder:new TextDecoder,buffer:new e,status:s.create({target:new i,callback:t=>{this._internal.emitter.emit("update",t)}}),printer:a.printer,language:a.language,polling:a.polling||"auto",callback:()=>{},response:()=>new Promise((t=>{this._internal.callback=t}))},this.barcodeScanner=new n(this),this.cashDrawer=new r(this),this.initialize()}initialize(){this._internal.printer.addEventListener("data",(t=>this.receive(t))),this._internal.printer.listen(),this._internal.printer.addEventListener("disconnected",(()=>{this._polling&&clearInterval(this._polling),this._connected=!1,this._internal.emitter.emit("disconnected")})),"auto"==this._language&&this.initializeUnknownPrinter(),"star-line"!=this._language&&"star-prnt"!=this._language||this.initializeStarPrinter(),"esc-pos"==this._language&&this.initializeEscPosPrinter(),setTimeout((()=>{this._connected||this._internal.emitter.emit("unsupported")}),1500)}initializeUnknownPrinter(){this.send([27,6,1]),this.send([16,4,1])}initializeStarPrinter(){"star-line"!=this._language&&"star-prnt"!=this._language||this.send([27,6,1]),"auto"==this._internal.polling&&setTimeout((()=>{1==this._updates&&(this._pollForUpdates=!0,this.poll())}),1e3),!0===this._internal.polling&&(this._pollForUpdates=!0,this.poll())}initializeEscPosPrinter(){this.send([29,97,79]),this.send([16,20,7,1])}async query(t){let e,s,i;if(await new Promise((t=>{setTimeout(t,10)})),"star-prnt"==this._language||"star-line"==this._language)switch(t){case"manufacturer":e="Star";break;case"model":if(this.send([27,35,42,10,0]),s=await this._internal.response(),i=s.match(/^(.*)Ver[0-9\.]+$/),i&&(e=i[1],"POP10"===e))e="mPOP";break;case"firmware":this.send([27,35,42,10,0]),e=await this._internal.response()}if("star-prnt"==this._language)switch(t){case"serialnumber":this.send([27,29,41,73,1,0,49]),s=await this._internal.response(),i=s.match(/PrSrN=([0-9]+)[,$]/),i&&(e=i[1]);break;case"fonts":this.send([27,29,41,73,3,0,48,0,0]),s=await this._internal.response(),e=s.split(",").filter((t=>t));break;case"interfaces":this.send([27,29,41,73,3,0,51,0,0]),e=await this._internal.response()}if("esc-pos"==this._language)switch(t){case"firmware":this.send([29,73,65]),e=await this._internal.response();break;case"manufacturer":this.send([29,73,66]),e=await this._internal.response();break;case"model":this.send([29,73,67]),e=await this._internal.response();break;case"serialnumber":this.send([29,73,68]),e=await this._internal.response();break;case"fonts":this.send([29,73,69]);let t=await this._internal.response();e=t?[t]:[]}return e}send(t){this._internal.printer.print(new Uint8Array(t))}receive(t){this._internal.buffer.add(t),this.parseResponse()}connect(){!1===this._connected&&(this._connected=!0,this._internal.emitter.emit("connected"))}poll(){this._polling||(this._polling=setInterval((()=>{this._connected&&("star-prnt"==this._language&&(this._pollForBarcodes&&this.send([27,29,66,50]),this._pollForUpdates&&this.send([27,6,1])),"star-line"==this._language&&this._pollForUpdates&&this.send([27,6,1]),"esc-pos"==this._language&&this._pollForUpdates&&this.send([16,20,7,1]))}),500))}parseResponse(){if(!this._parsing){for(this._parsing=!0;this._internal.buffer.length;){let t=1;if("auto"==this._language&&(this._language=this.detectLanguage(this._internal.buffer)),"star-line"!=this._language&&"star-prnt"!=this._language||(t=this.parseStarResponse(this._internal.buffer)),"esc-pos"==this._language&&(t=this.parseEscPosResponse(this._internal.buffer)),0==t)break;this._internal.buffer.cursor+=t}this._parsing=!1}}detectLanguage(t){return t.checkBits("0..1..10")?(this.initializeEscPosPrinter(),"esc-pos"):t.checkBits("0..0...1")?(this.initializeStarPrinter(),"star-prnt"):"unknown"}parseEscPosResponse(t){let e=0,{window:s,length:i}=t;if(i>=4&&t.checkBits("0..1..00"))this._internal.status.online=t.checkBits("....0..."),this._internal.status.coverOpened=t.checkBits("..1....."),this._internal.status.buttonPressed=t.checkBits(".1......"),this._internal.status.paperLoaded=t.checkBits(2,"....00.."),this._internal.status.paperLow=t.checkBits(2,"......11"),this.cashDrawer.opened=t.checkBits(".....0.."),this._updates++,this.connect(),e=4;else if(i>=1&&t.checkBits("0..1..10"))this._internal.status.online=t.checkBits("....0..."),this._internal.status.buttonPressed=t.checkBits(".1......"),this.cashDrawer.opened=t.checkBits(".....0.."),e=1;else if(i>=2&&95==t.get()){let i=t.scanUntilNul(s);if(null!==i){let s=t.get(1,i-1);this._internal.callback(this._internal.decoder.decode(s)),e=i}}else e=1;return e}parseStarResponse(t){let e=0,{window:s,length:i}=t;if(t.checkBits("0..0...1")){let s=t.getBits("..3.210.");if(i>=s){if(0==this._updates){let e=t.getBits(1,"..3.210.");this._language=e>=4?"star-prnt":"star-line","star-prnt"==this._language&&this.send([27,29,66,49])}this._internal.status.online=t.checkBits(2,"....0..."),this._internal.status.coverOpened=t.checkBits(2,"..1....."),this._internal.status.buttonPressed=t.checkBits(2,".1......"),this._internal.status.paperLoaded=t.checkBits(5,"....0..."),this.cashDrawer.opened=t.checkBits(2,".....1.."),this._updates++,this.connect(),e=s}}else if(i>=7&&t.checkSequence([27,35,42,44])){let i=t.scanUntilLineFeedNul(s);if(null!==i){let s=t.get(4,i-2);this._internal.callback(this._internal.decoder.decode(s)),e=i}}else if(i>=9&&t.checkSequence([27,29,41,73])){let i=t.scanUntilLineFeedNul(s);if(null!==i){let s=t.getWord(4),n=t.get(6+s,i-2);this._internal.callback(this._internal.decoder.decode(n)),e=i}}else if(i>=5&&t.checkSequence([27,29,66,49]))2&t.get(4)&&(this.barcodeScanner.connected=!0,this._pollForBarcodes=!0,this.poll()),e=5;else if(i>=5&&t.checkSequence([27,29,66,50])){let s=t.getWord(4);if(s>0){let e=t.get(6,6+s-1);this._internal.decoder.decode(e).split("\r").forEach((t=>{""!=(t=t.trim())&&(this.barcodeScanner.barcode=t)}))}e=6+s}else e=27==t.get()?0:1;return e}addEventListener(t,e){this._internal.emitter.on(t,e)}get status(){return this._internal.status.target}get connected(){return this._connected}get language(){return this._language}}export{a as default};
